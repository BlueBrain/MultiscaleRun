include:
  - project: hpc/gitlab-pipelines
    file: 
      - spack-build-components.gitlab-ci.yml
      - bbp-gitlab-access.yml

default:
  tags: [bb5_map]

variables:
  STEPS_BRANCH:
    value: master
  NEURODAMUS_NEOCORTEX_BRANCH:
    value: main

#spack_setup:
#  extends: .spack_setup_ccache

#bbp_repos_access:
#  stage: .pre
#  extends: .bbp_gitlab_access

.build:
  extends: [.spack_build]
  variables:
    bb5_ntasks: 2   # so we block 16 cores
    bb5_cpus_per_task: 8 # ninja -j {this}
    bb5_memory: 76G # ~16*384/80

.steps_setup:
  extends: [.build]
  variables:
    SPACK_PACKAGE: steps
    SPACK_PACKAGE_SPEC: +distmesh+petsc

.neurodamus_setup:
  extends: [.build]
  variables:
    SPACK_PACKAGE: neurodamus-neocortex
    SPACK_PACKAGE_SPEC: +ngv

dualrun_test:
  stage: test
#  needs:
#    - bbp_repos_access
#    - steps_setup
#    - neurodamus_setup
  variables:
    bb5_exclusive: "full"
    bb5_duration: "01:00:00"
    bb5_constraint: cpu
    bb5_ntasks: 16
    bb5_cpus_per_task: 1
  script:
#    - . ${SPACK_ROOT}/share/spack/setup-env.sh
    - export XDG_CONFIG_HOME=${CI_BUILDS_DIR}/J${CI_JOB_ID}_local_config
    - echo "Configuring git to use CI_JOB_TOKEN to access git@bbpgitlab.epfl.ch (${XDG_CONFIG_HOME})"
    - mkdir -p "${XDG_CONFIG_HOME}/git"
    - echo -e "[url \"https://gitlab-ci-token:${CI_JOB_TOKEN}@bbpgitlab.epfl.ch/\"]\n  insteadOf = git@bbpgitlab.epfl.ch:" > "${XDG_CONFIG_HOME}/git/config"
    - echo -e "[url \"https://gitlab-ci-token:${CI_JOB_TOKEN}@bbpgitlab.epfl.ch/\"]\n  insteadOf = ssh://git@bbpgitlab.epfl.ch/" >> "${XDG_CONFIG_HOME}/git/config"
    - cat "${XDG_CONFIG_HOME}/git/config"
    - .ci/test_dualrun.sh

triplerun_test:
  stage: test
#  needs:
#    - bbp_repos_access
#    - steps_setup
#    - neurodamus_setup
  variables:
    bb5_exclusive: "full"
    bb5_duration: "02:00:00"
    bb5_constraint: cpu
    bb5_ntasks: 32
    bb5_cpus_per_task: 1
  script:
#    - . ${SPACK_ROOT}/share/spack/setup-env.sh
    - export XDG_CONFIG_HOME=${CI_BUILDS_DIR}/J${CI_JOB_ID}_local_config
    - echo "Configuring git to use CI_JOB_TOKEN to access git@bbpgitlab.epfl.ch (${XDG_CONFIG_HOME})"
    - mkdir -p "${XDG_CONFIG_HOME}/git"
    - echo -e "[url \"https://gitlab-ci-token:${CI_JOB_TOKEN}@bbpgitlab.epfl.ch/\"]\n  insteadOf = git@bbpgitlab.epfl.ch:" > "${XDG_CONFIG_HOME}/git/config"
    - echo -e "[url \"https://gitlab-ci-token:${CI_JOB_TOKEN}@bbpgitlab.epfl.ch/\"]\n  insteadOf = ssh://git@bbpgitlab.epfl.ch/" >> "${XDG_CONFIG_HOME}/git/config"
    - cat "${XDG_CONFIG_HOME}/git/config"
    - .ci/test_triplerun.sh
